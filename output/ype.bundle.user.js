// ==UserScript==
// @name            Your Personal Engineer
// @description     Makes your trading routine more comfortable.
// @author          https://steamcommunity.com/id/EurekaEffect/
// @version         1.0

// @updateURL       https://github.com/EurekaEffect/your-personal-engineer/raw/refs/heads/master/output/ype.bundle.user.js
// @downloadURL     https://github.com/EurekaEffect/your-personal-engineer/raw/refs/heads/master/output/ype.bundle.user.js

// @match           *://backpack.tf/stats/*
// @match           *://backpack.tf/classifieds*
// @match           *://steamcommunity.com/tradeoffer/new*

// @run-at          document-idle
// ==/UserScript==
(()=>{"use strict";var e={279:function(e,t,n){var o=this&&this.__awaiter||function(e,t,n,o){return new(n||(n=Promise))((function(r,i){function a(e){try{s(o.next(e))}catch(e){i(e)}}function d(e){try{s(o.throw(e))}catch(e){i(e)}}function s(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,d)}s((o=o.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.alert=a,t.log=d,t.throwError=s,t.getWindow=c;const r=n(366);function i(e){const t="UserThem"===e;if("UserYou"!==e&&!t)return console.error(`[YPE, Main.loadInventory] Unknown user '${e}'.`);t&&c()[e].loadInventory(440,2);const n=c()[e].OnLoadInventoryComplete;c()[e].OnLoadInventoryComplete=function(o,r,i){c()[e].OnLoadInventoryComplete=n,c()[e].OnLoadInventoryComplete(o,r,i);const a=c()[e].getInventory(440,2);t&&(a.Initialize(),a.MakeActive(),c().g_ActiveInventory=a,c().g_ActiveInventory.hide(),c().SelectInventoryFromUser(c().UserYou,440,2,!1));const d=new CustomEvent("inventory_load_complete",{detail:{user:e,inventory:a}});window.dispatchEvent(d)}}function a(e){window.alert(`Script: Your Personal Engineer\nMessage: ${e}`)}function d(e,t){console.log(`[YPE, ${e}] ${t}`)}function s(e){throw Error(e)}function c(){return unsafeWindow}!function(){o(this,void 0,void 0,(function*(){(0,r.isTradeOfferUrl)(location.href)&&(i("UserYou"),i("UserThem"))}))}(),window.addEventListener("inventory_load_complete",(e=>{const t=e.detail.user,n="UserThem"===t,o=(e.detail.inventory.rgInventory,new URLSearchParams(location.search)),i=o.get("ype.asset_id"),c=o.get("ype.item_name");if(n&&i)try{d("Main.inventory_load_complete",`Adding an item with id ${i} to the trade offer.`),(0,r.SetItemInTrade)(i)}catch(e){if(d("Main.inventory_load_complete",`Item with id ${i} not found.`),c){d("Main.inventory_load_complete",`Searching for '${c}' instead.`);const e=(0,r.SearchItemByName)(t,c);if(e)d("Main.inventory_load_complete",`Found an item with the exact name, it's id is ${e}, adding to the trade offer.`),(0,r.SetItemInTrade)(e);else{const e=`Cannot find an item with id ${i} or with item '${c}'.`;a(e),s(e)}}else{const e=`Cannot find an item with id ${i}, ype.item_name is not presents.`;a(e),s(e)}}}))},366:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.SetItemsInTrade=function(e){const t=(0,o.getWindow)().CTradeOfferStateManager,n=t.UpdateTradeStatus;t.UpdateTradeStatus=function(){};for(let n of e){const e=document.querySelector(`#item440_2_${n}`);if(e){const r=e.rgItem;(0,o.getWindow)().BIsInTradeSlot(r)?(0,o.throwError)(`Item with id '${n}' is already in a trade slot.`):t.SetItemInTrade(r,0,1)}else(0,o.throwError)(`Item with id '${n}' not found.`)}t.UpdateTradeStatus=n,t.UpdateTradeStatus()},t.SetItemInTrade=function(e){const t=document.querySelector(`#item440_2_${e}`);if(t){const n=t.rgItem;(0,o.getWindow)().BIsInTradeSlot(n)?(0,o.throwError)(`Item with id '${e}' is already in a trade slot.`):(0,o.getWindow)().CTradeOfferStateManager.SetItemInTrade(n,0,1)}else(0,o.throwError)(`Item with id '${e}' not found.`)},t.SearchItemByName=function(e,t){"UserYou"===e||"UserThem"===e||(0,o.throwError)(`Unknown user '${e}'.`);const n=(0,o.getWindow)()[e].getInventory(440,2).rgInventory;for(let e in n)if(n[e].market_name===t)return e},t.removeItemFromTradeOffer=function(e){},t.refreshTradeStatus=function(){(0,o.getWindow)().RefreshTradeStatus((0,o.getWindow)().g_rgCurrentTradeStatus)},t.isTradeOfferUrl=function(e){return/^https:\/\/steamcommunity\.com\/tradeoffer\/new\/\?partner=\d+&token=.+$/.test(e)};const o=n(279)}},t={};!function n(o){var r=t[o];if(void 0!==r)return r.exports;var i=t[o]={exports:{}};return e[o].call(i.exports,i,i.exports,n),i.exports}(279)})();