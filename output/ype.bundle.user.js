// ==UserScript==
// @name            Your Personal Engineer
// @description     Makes your trading routine more comfortable.
// @author          https://steamcommunity.com/id/EurekaEffect/
// @version         1.0

// @updateURL       https://github.com/EurekaEffect/your-personal-engineer/raw/refs/heads/master/output/ype.bundle.user.js
// @downloadURL     https://github.com/EurekaEffect/your-personal-engineer/raw/refs/heads/master/output/ype.bundle.user.js

// @match           *://backpack.tf/stats/*
// @match           *://backpack.tf/classifieds*
// @match           *://steamcommunity.com/tradeoffer/new*

// @run-at          document-idle
// ==/UserScript==
(()=>{"use strict";var e={551:function(e,t){var n=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(o,i){function a(e){try{c(r.next(e))}catch(e){i(e)}}function s(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,s)}c((r=r.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.isClassifiedsUrl=function(e){return/^https:\/\/backpack\.tf\/classifieds\?.+$|^https:\/\/backpack\.tf\/stats\/.+$/.test(e)},t.mainClassifieds=function(){return n(this,void 0,void 0,(function*(){document.querySelector("head").insertAdjacentHTML("afterend",r),document.querySelectorAll(".listing").forEach((e=>{const t=e.querySelector(".item"),n=e.querySelector(".listing-buttons"),r=t.getAttribute("data-id"),i=t.getAttribute("title"),a=t.getAttribute("data-listing_price"),s=function(){const t=e.querySelector(".user-link").getAttribute("data-offers-params");return t?`https://steamcommunity.com/tradeoffer/new/${t}`:void 0}();if(s){n.insertAdjacentHTML("beforeend",o);const t=e.querySelector(".btn.btn-bottom.btn-xs.btn-success.hover-able");t.addEventListener("click",(()=>{const e={asset_id:r,item_name:i,amount:t.getAttribute("ype.amount"),currencies:c(a||"0 key, 0 ref")};open(`${s}&ype=${JSON.stringify(e)}`,"_blank")}))}function c(e){const t=/\b(\d+(\.\d+)?)\s(key|keys|ref|refs)\b/g;function n(e){const t={},n=e[1];let r=e[3];return"key"!==r&&"keys"!==r||(r="keys"),"ref"!==r&&"refs"!==r||(r="metal"),t[r]=parseFloat(n),t}const r={};let o;for(;null!==(o=t.exec(e));){const e=n(o);Object.assign(r,e)}return r}}))}))};const r='<style>\n        .hover-able {\n            cursor: pointer;\n            position: relative;\n            display: inline-block;\n            z-index: 1;\n        }\n\n        .popup-panel {\n            position:absolute;\n            top: -43px;\n            left: 50%;\n            width: 125px;\n            transform: translateX(-50%);\n            display:none;\n            z-index:1070;\n            background-color: black;\n            color: white;\n            font-family:"Helvetica Neue",Roboto,Arial,sans-serif;\n            font-size:12px;\n            font-weight:400;\n            line-height:1.4;\n            opacity: 0.9;\n            margin-top:-3px;\n            padding:5px 5px;\n            border-radius: 5px;\n        }\n\n        .hover-able:hover .popup-panel {\n            display: block;\n        }\n\n        .popup-panel:hover {\n            display:block;\n        }\n        \n        output {\n            color: white; \n            margin: -5px\n        }\n    </style>',o='<a class="btn btn-bottom btn-xs btn-success hover-able" style="background-color: rgb(185, 143, 200); border-color: rgb(185, 143, 200)" ype.asset_id="" ype.item_name="" ype.amount="1" ype.currencies="">\n        <i class="fa fa-fire"></i>\n        <div class="popup-panel" onclick="event.stopPropagation()">\n            <input type="range" value="1" min="1" max="50" oninput="this.nextElementSibling.value = this.value; this.parentNode.parentNode.setAttribute(\'ype.amount\', parseInt(this.value))" draggable="false">\n            <output>1</output>\n        </div>\n    </a>'},279:function(e,t,n){var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(o,i){function a(e){try{c(r.next(e))}catch(e){i(e)}}function s(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,s)}c((r=r.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.alert=function(e){window.alert(`Script: Your Personal Engineer\n${e}`)},t.log=function(e,t){console.log(`[YPE, ${e}] ${t}`)},t.error=function(e,t){console.error(`[YPE, ${e}] ${t}`)},t.throwError=function(e){throw Error(e)},t.getWindow=function(){return unsafeWindow};const o=n(849),i=n(551);!function(){r(this,void 0,void 0,(function*(){const e=(0,o.isTradeOfferUrl)(location.href),t=(0,i.isClassifiedsUrl)(location.href);e?yield(0,o.mainTradeOffer)():t&&(yield(0,i.mainClassifieds)())}))}()},849:function(e,t,n){var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(o,i){function a(e){try{c(r.next(e))}catch(e){i(e)}}function s(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,s)}c((r=r.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.isTradeOfferUrl=function(e){return/^https:\/\/steamcommunity\.com\/tradeoffer\/new\/\?partner=\d+&token=.+$/.test(e)},t.mainTradeOffer=function(){return r(this,void 0,void 0,(function*(){const e=new l;!function(){function e(e,t){let n=(0,o.getWindow)().CTradeOfferStateManager[e];(0,o.getWindow)().CTradeOfferStateManager[e]=function r(i,a,s){(0,o.getWindow)().CTradeOfferStateManager[e]=n,(0,o.getWindow)().CTradeOfferStateManager[e](i,a,s),n=(0,o.getWindow)().CTradeOfferStateManager[e],(0,o.getWindow)().CTradeOfferStateManager[e]=r;const c=new CustomEvent("item_interaction",{detail:{user:i.is_their_item?"UserThem":"UserYou",item:i,type:t}});window.dispatchEvent(c)}}function t(e,t){const n=document.querySelector(`#${e}`);null==n||n.addEventListener("click",(()=>{(0,o.getWindow)().SelectInventoryFromUser((0,o.getWindow)()[t],440,2,!1);const e=(0,o.getWindow)()[t]===(0,o.getWindow)().UserThem,n=new CustomEvent("inventory_selected",{detail:{user:e?"UserThem":"UserYou"}});window.dispatchEvent(n)}))}e("SetItemInTrade","added"),e("RemoveItemFromTrade","removed"),t("inventory_select_your_inventory","UserYou"),t("inventory_select_their_inventory","UserThem")}(),c("UserYou"),c("UserThem"),window.addEventListener("inventory_load_complete",(t=>r(this,void 0,void 0,(function*(){const n=t.detail.user,r="UserYou"===n,c="UserThem"===n,l=(t.detail.inventory.rgInventory,new URLSearchParams(location.search).get("ype")),d=l?JSON.parse(l):{},{asset_id:u,item_name:m,currencies:f}=d;let y=d.amount?d.amount:1;if((0,o.log)("Main.inventory_load_complete",`${n} inventory was loaded.`),r&&(a=!0,e.updateCurrencies(n)),c){let e;if(s=!0,u){(0,o.log)("Main.inventory_load_complete",`Searching for the item(${u}).`);try{yield(0,i.SetItemInTrade)(u),(0,o.log)("Main.inventory_load_complete",`Item(${u}) was found and added.`),e=!0}catch(t){(0,o.log)("Main.inventory_load_complete",`Item(${u}) not found.`),e=!1}}else(0,o.log)("Main.inventory_load_complete","'asset_id' parameter not present."),e=!1;let t=e?y-1:y;if(m)if(t<=0)(0,o.log)("Main.inventory_load_complete","The amount_to_add is 0.");else{(0,o.log)("Main.inventory_load_complete",`Searching for '${t}' items with name '${m}'.`);let e=(0,i.SearchItemsByName)(n,m);e=e.slice(0,t),yield(0,i.SetItemsInTrade)(e)}else(0,o.log)("Main.inventory_load_complete","'item_name' parameter not present.")}if(!f)return(0,o.error)("Main.inventory_load_complete","'currency' parameter not present.");if(a&&s){const t=(0,o.getWindow)().g_rgCurrentTradeStatus.them.assets.length;if(t>0){let n=f.keys,r=f.metal,i=Math.round(r/.05555555555555555);i*=t,n*=t,r=Math.floor(i/18*100)/100,e.updateCurrencyPanelInfoAndClick(n,r),String(t)!==String(y)&&(0,o.alert)(`I found only '${t}' items in your partner's inventory instead of the expected '${y}'.`)}else(0,o.alert)("Your partner's side doesn't have any items.")}})))),window.addEventListener("item_interaction",(t=>{const n=t.detail.user;t.detail.item,e.updateCurrencies(n)})),window.addEventListener("inventory_selected",(t=>{const n=t.detail.user;e.updateCurrencies(n)}))}))};const o=n(279),i=n(373);let a=!1,s=!1;function c(e){const t="UserThem"===e;if("UserYou"!==e&&!t)return(0,o.error)("[YPE, Main.loadInventory]",`Unknown user '${e}'.`);t&&(0,o.getWindow)()[e].loadInventory(440,2);const n=(0,o.getWindow)()[e].OnLoadInventoryComplete;(0,o.getWindow)()[e].OnLoadInventoryComplete=function(r,i,a){(0,o.getWindow)()[e].OnLoadInventoryComplete=n,(0,o.getWindow)()[e].OnLoadInventoryComplete(r,i,a);const s=(0,o.getWindow)()[e].getInventory(440,2);t&&(s.Initialize(),s.MakeActive(),(0,o.getWindow)().g_ActiveInventory=s,(0,o.getWindow)().g_ActiveInventory.hide(),(0,o.getWindow)().SelectInventoryFromUser((0,o.getWindow)().UserYou,440,2,!1));const c=new CustomEvent("inventory_load_complete",{detail:{user:e,inventory:s}});window.dispatchEvent(c)}}class l{constructor(){var e,t;this.items=new d;const n=document.querySelector(".trade_right.selectableNone");null==n||n.insertAdjacentHTML("afterbegin",'<div id="currency-panel" class="your_items">\n    <div class="trade_box_bgheader active"></div>\n    <div class="trade_box_contents" style="background: #1D1D1D">\n        <div id="warning-text" class="tutorial_arrow_ctn" style="text-align: center; color: #d83636"></div>\n        <div class="tutorial_arrow_ctn" style="display: flex; flex-direction: row; flex-wrap: nowrap; justify-content: space-around; align-items: stretch; align-content: stretch;">\n            <div style="position: relative; text-align: center; color: white"><img src="https://community.cloudflare.steamstatic.com/economy/image/fWFc82js0fmoRAP-qOIPu5THSWqfSmTELLqcUywGkijVjZULUrsm1j-9xgEAaR4uURrwvz0N252yVaDVWrRTno9m4ccG2GNqxlQoZrC2aG9hcVGUWflbX_drrVu5UGki5sAij6tOtQ/96fx96f"><div id="key-count" style="position: absolute; bottom: 10px; right: 10px">0x</div></div>\n            <div style="position: relative; text-align: center; color: white"><img src="https://community.cloudflare.steamstatic.com/economy/image/fWFc82js0fmoRAP-qOIPu5THSWqfSmTELLqcUywGkijVjZULUrsm1j-9xgEbZQsUYhTkhzJWhsO1Mv6NGucF1Ygzt8ZQijJukFMiMrbhYDEwI1yRVKNfD6xorQ3qW3Jr6546DNPuou9IOVK4p4kWJaA/96fx96f"><div id="ref-count" style="position: absolute; bottom: 10px; right: 10px">0x</div></div>\n            <div style="position: relative; text-align: center; color: white"><img src="https://community.cloudflare.steamstatic.com/economy/image/fWFc82js0fmoRAP-qOIPu5THSWqfSmTELLqcUywGkijVjZULUrsm1j-9xgEbZQsUYhTkhzJWhsO0Mv6NGucF1YJlscMEgDdvxVYsMLPkMmFjI1OSUvMHDPBp9lu0CnVluZQxA9Gwp-hIOVK4sMMNWF4/96fx96f"><div id="rec-count" style="position: absolute; bottom: 10px; right: 10px">0x</div></div>\n            <div style="position: relative; text-align: center; color: white"><img src="https://community.cloudflare.steamstatic.com/economy/image/fWFc82js0fmoRAP-qOIPu5THSWqfSmTELLqcUywGkijVjZULUrsm1j-9xgEbZQsUYhTkhzJWhsPZAfOeD-VOn4phtsdQ32ZtxFYoN7PkYmVmIgeaUKNaX_Rjpwy8UHMz6pcxAIfnovUWJ1t9nYFqYw/96fx96f"><div id="scrap-count" style="position: absolute; bottom: 10px; right: 10px">0x</div></div>\n        </div>\n        <div style="display: flex; flex-direction: row; flex-wrap: nowrap; justify-content: space-around; align-items: stretch; align-content: stretch;" class="tutorial_arrow_ctn">\n            <input id="keys" placeholder="Keys" class="filter_search_box" type="number">\n            <input id="metal" placeholder="Metal" class="filter_search_box" type="number">\n            <a id="add-currency" class="pagecontrol_element pagebtn">Add</a>\n        </div>\n    </div>\n</div>'),null===(t=null===(e=this.get())||void 0===e?void 0:e.querySelector("#add-currency"))||void 0===t||t.addEventListener("click",(()=>{const e=document.querySelector("#keys"),t=document.querySelector("#metal");if(!e||!t)return(0,o.throwError)("Cannot find 'keys' or 'metal' element.");const n=e.value?parseInt(e.value):0;let r=t.value?parseFloat(t.value):0;if(isNaN(n)||isNaN(r))return(0,o.alert)("Only numbers are allowed in 'keys' and 'metal' textboxes."),(0,o.throwError)("Only numbers are allowed in 'keys' and 'metal' textboxes.");if(n<0||r<0)return(0,o.alert)("Only non-negative numbers are allowed in 'keys' and 'metal' textboxes."),(0,o.throwError)("Only non-negative numbers are allowed in 'keys' and 'metal' textboxes.");const a=(0,o.getWindow)().g_ActiveUser===(0,o.getWindow)().UserThem?"UserThem":"UserYou",s=this.items.getCurrenciesInInventory(a);let c=Math.round(r/.05555555555555555),l=Math.floor(c/18);l=Math.min(s.ref.length,l),c-=18*l;let d=Math.floor(c/6);d=Math.min(s.rec.length,d),c-=6*d;let u=Math.floor(c/2);if(u=Math.min(s.scrap.length,u),c-=2*u,n>s.key.length||c>0){const e=0===n?0:n-s.key.length,t=Math.floor(c/18*100)/100;e&&t?this.showWarning(`You are missing ${e} keys ${t} metal.`):e?this.showWarning(`You are missing ${e} keys.`):this.showWarning(`You are missing ${t} metal.`)}else{this.hideWarning();const e=[...s.key.slice(0,n),...s.ref.slice(0,l),...s.rec.slice(0,d),...s.scrap.slice(0,u)].map((e=>e.id));(0,i.SetItemsInTrade)(e),this.updateCurrencies(a)}}))}get(){return document.querySelector("#currency-panel")}showWarning(e){document.querySelector("#warning-text").textContent=e}hideWarning(){document.querySelector("#warning-text").textContent=""}updateCurrencies(e){const t=this.items.getCurrenciesInInventory(e);this.updateCurrency("key-count",t.key.length),this.updateCurrency("ref-count",t.ref.length),this.updateCurrency("rec-count",t.rec.length),this.updateCurrency("scrap-count",t.scrap.length)}updateCurrency(e,t){["key-count","ref-count","rec-count","scrap-count"].includes(e)||(0,o.throwError)(`Item id '${e}' is not valid.`);const n=document.querySelector(`#${e}`);n?(n.parentNode.style.opacity=t>0?"100%":"40%",n.textContent=`${t}x`):(0,o.throwError)(`Element '${e}' was not found.`)}updateCurrencyPanelInfoAndClick(e,t){const n=document.querySelector("#keys"),r=document.querySelector("#metal"),o=document.querySelector("#add-currency");n.value=e,r.value=t,o.click()}}class d{constructor(){this.class_ids={key:"101785959",ref:"2674",rec:"5564",scrap:"2675"}}getCurrenciesInInventory(e){return{key:this.getItemsByClassId(e,this.class_ids.key),ref:this.getItemsByClassId(e,this.class_ids.ref),rec:this.getItemsByClassId(e,this.class_ids.rec),scrap:this.getItemsByClassId(e,this.class_ids.scrap)}}getItemsByClassId(e,t){"UserYou"===e||"UserThem"===e||(0,o.throwError)(`Unknown user '${e}'.`);const n=(0,o.getWindow)()[e].getInventory(440,2).rgInventory,r=[];for(let e in n){const i=n[e],a=i.element;(0,o.getWindow)().BIsInTradeSlot(a)||i.classid===t&&r.push(i)}return r}}},373:function(e,t,n){var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(o,i){function a(e){try{c(r.next(e))}catch(e){i(e)}}function s(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,s)}c((r=r.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.SetItemsInTrade=function(e){return r(this,void 0,void 0,(function*(){return new Promise((t=>r(this,void 0,void 0,(function*(){const n=(0,o.getWindow)().CTradeOfferStateManager;for(let t of e){const e=document.querySelector(`#item440_2_${t}`);if(e){const r=e.rgItem;(0,o.getWindow)().BIsInTradeSlot(r)?(alert(`Item with id '${t}' is already in a trade slot.`),(0,o.error)("TradeOffer.SetItemsInTrade",`Item with id '${t}' is already in a trade slot.`)):yield new Promise((e=>{setTimeout((()=>{n.SetItemInTrade(r,0,1),e(!0)}),1)}))}else alert(`Item with id '${t}' not found.`),(0,o.error)("TradeOffer.SetItemsInTrade",`Item with id '${t}' not found.`)}t(e)}))))}))},t.SetItemInTrade=function(e){return r(this,void 0,void 0,(function*(){return new Promise(((t,n)=>r(this,void 0,void 0,(function*(){const r=document.querySelector(`#item440_2_${e}`);if(r){const i=r.rgItem;(0,o.getWindow)().BIsInTradeSlot(i)?n(`Item with id '${e}' is already in a trade slot.`):((0,o.getWindow)().CTradeOfferStateManager.SetItemInTrade(i,0,1),yield new Promise((e=>{setTimeout((()=>{(0,o.getWindow)().CTradeOfferStateManager.SetItemInTrade(i,0,1),e(!0)}),1)})),t(!0))}else n(`Item with id '${e}' not found.`);t(!1)}))))}))},t.SearchItemsByName=function(e,t){"UserYou"===e||"UserThem"===e||(0,o.throwError)(`Unknown user '${e}'.`);const n=(0,o.getWindow)()[e].getInventory(440,2).rgInventory,r=[];for(let e in n){const i=n[e],a=i.market_name;(0,o.getWindow)().BIsInTradeSlot(i)||a===t&&r.push(e)}return r},t.removeItemFromTradeOffer=function(e){},t.refreshTradeStatus=function(){(0,o.getWindow)().RefreshTradeStatus((0,o.getWindow)().g_rgCurrentTradeStatus)};const o=n(279)}},t={};!function n(r){var o=t[r];if(void 0!==o)return o.exports;var i=t[r]={exports:{}};return e[r].call(i.exports,i,i.exports,n),i.exports}(279)})();