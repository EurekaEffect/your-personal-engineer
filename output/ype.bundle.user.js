// ==UserScript==
// @name            Your Personal Engineer
// @description     Makes your trading routine more comfortable.
// @author          https://steamcommunity.com/id/EurekaEffect/
// @version         1.4

// @updateURL       https://github.com/EurekaEffect/your-personal-engineer/raw/refs/heads/master/output/ype.bundle.user.js
// @downloadURL     https://github.com/EurekaEffect/your-personal-engineer/raw/refs/heads/master/output/ype.bundle.user.js

// @match           *://backpack.tf/*
// @match           *://steamcommunity.com/tradeoffer/new*
// @match           *://tradeit.gg/tf2/*

// @run-at          document-idle
// ==/UserScript==
(()=>{"use strict";var e={679:function(e,t,n){var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(o,i){function a(e){try{c(r.next(e))}catch(e){i(e)}}function s(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,s)}c((r=r.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.isBackpackUrl=function(e){return/^https:\/\/backpack\.tf.+$/.test(e)},t.mainBackpack=function(){return r(this,void 0,void 0,(function*(){Array.from(document.querySelectorAll(".item.q-440-6.q-440-border-6")).filter((e=>{const t=e.getAttribute("data-name");return!!t&&"Fabricator"===t})).forEach((e=>{const t=new CustomEvent("item_added",{detail:{item:e}});window.dispatchEvent(t)})),(0,i.listenForDynamicallyAddedItems)("item","backpack.tf")}))};const o=n(564),i=n(36);window.addEventListener("item_added",(e=>{const t=e.detail.item;if("backpack.tf"!==e.detail.initiator)return;const n=t.getAttribute("data-name");if(!n)return!1;if("Fabricator"===n){const e=(0,o.getCompletePercentage)(t),n=(0,o.getNeededInput)(t);!function(e,t,n){const r=function(e){let t,n,r;return(e=Math.min(100,Math.max(0,e)))<=50?(t=e/50*255,n=255,r=0):(t=255,n=255*(1-(e-50)/50),r=0),`rgb(${Math.round(t)}, ${Math.round(n)}, ${Math.round(r)})`}(t),o=document.createElement("div");o.className="tag top-right",o.innerText=`${t}%`,o.style.color=r;const i=document.createElement("div");i.className="tag top-right",i.innerText=`${n} ks`,e.appendChild(o),Object.assign(i.style,{top:`${o.clientHeight}px`}),e.appendChild(i)}(t,e,(0,o.getKillstreakItemAmount)(n))}}))},551:function(e,t){var n=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(o,i){function a(e){try{c(r.next(e))}catch(e){i(e)}}function s(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,s)}c((r=r.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.isClassifiedsUrl=function(e){return/^https:\/\/backpack\.tf\/classifieds\?.+$|^https:\/\/backpack\.tf\/stats\/.+$/.test(e)},t.mainClassifieds=function(){return n(this,void 0,void 0,(function*(){document.querySelector("head").insertAdjacentHTML("afterend",r);const e=document.querySelectorAll(".listing");for(const t of e){const e=t.querySelector(".item"),n=t.querySelector(".listing-body"),r=t.querySelector(".listing-buttons");if(!e.getAttribute("data-listing_price"))continue;const c=a(t);if(c){r.insertAdjacentHTML("beforeend",o);const a=t.querySelector(".btn.btn-bottom.btn-xs.btn-success.hover-able"),l=a.querySelector(".popup-panel");a.addEventListener("mouseenter",(()=>{l.style.display="block"})),l.addEventListener("mouseleave",(()=>{l.style.display="none"}));let d=t.querySelector(".fa.fa-sw.fa-flash");d?d=d.cloneNode(!0):(d=document.createElement("i"),d.classList.add("fa","fa-sw","fa-exchange")),a.prepend(d),a.addEventListener("click",(()=>{let t=e.getAttribute("data-listing_intent"),r=e.getAttribute("data-id"),o=i(e,n),l=a.getAttribute("ype.amount");const d=s(e.getAttribute("data-listing_price")),u={intent:t,asset_id:r&&0!==r.length?r:void 0,item_name:o.item_name,item_data:o.item_data,amount:l,currencies:d},f=`${c}&ype=${JSON.stringify(u)}`;open(f,"_blank")}))}}}))};const r='<style>\n        .hover-able {\n            cursor: pointer;\n            position: relative;\n            display: inline-block;\n            z-index: 1;\n        }\n\n        .popup-panel {\n            position:absolute;\n            top: -43px;\n            left: 50%;\n            width: 125px;\n            transform: translateX(-50%);\n            display:none;\n            z-index:1070;\n            background-color: black;\n            color: white;\n            font-family:"Helvetica Neue",Roboto,Arial,sans-serif;\n            font-size:12px;\n            font-weight:400;\n            line-height:1.4;\n            opacity: 0.9;\n            margin-top:-3px;\n            padding:5px 5px;\n            border-radius: 5px;\n        }\n        \n        output {\n            color: white; \n            margin: -5px\n        }\n    </style>',o='<a class="btn btn-bottom btn-xs btn-success hover-able" style="background-color: rgb(185, 143, 200); border-color: rgb(185, 143, 200)" ype.amount="1">\n        <div class="popup-panel" onclick="event.stopPropagation()">\n            <input type="range" value="1" min="1" max="50" oninput="this.nextElementSibling.value = this.value; this.parentNode.parentNode.setAttribute(\'ype.amount\', parseInt(this.value))" draggable="false">\n            <output>1</output>\n        </div>\n    </a>';function i(e,t){var n,r,o;let i=null===(o=null===(r=null===(n=null==t?void 0:t.querySelector("h5"))||void 0===n?void 0:n.firstChild)||void 0===r?void 0:r.textContent)||void 0===o?void 0:o.trim(),a={};return"0"===e.getAttribute("data-craftable")&&(i=null==i?void 0:i.substring(14),a.craftable=!1),{item_name:i,item_data:a}}function a(e){const t=e.querySelector(".user-link").getAttribute("data-offers-params");return t?`https://steamcommunity.com/tradeoffer/new/${t}`:void 0}function s(e){const t=/\b(\d+(\.\d+)?)\s(key|keys|ref|refs)\b/g;function n(e){const t={},n=e[1];let r=e[3];return"key"!==r&&"keys"!==r||(r="keys"),"ref"!==r&&"refs"!==r||(r="metal"),t[r]=parseFloat(n),t}const r={};let o;for(;null!==(o=t.exec(e));){const e=n(o);Object.assign(r,e)}return r.keys||(r.keys=0),r.metal||(r.metal=0),r}},279:function(e,t,n){var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(o,i){function a(e){try{c(r.next(e))}catch(e){i(e)}}function s(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,s)}c((r=r.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.alert=function(e){window.alert(`Script: Your Personal Engineer\n${e}`)},t.log=function(e,t){console.log(`[YPE, ${e}] ${t}`)},t.error=function(e,t){console.error(`[YPE, ${e}] ${t}`)},t.throwError=function(e){throw Error(e)},t.getWindow=function(){return unsafeWindow};const o=n(849),i=n(551),a=n(679),s=n(122);!function(){r(this,void 0,void 0,(function*(){const e=(0,a.isBackpackUrl)(location.href),t=(0,s.isTradeItUrl)(location.href),n=(0,o.isTradeOfferUrl)(location.href),r=(0,i.isClassifiedsUrl)(location.href);e&&(yield(0,a.mainBackpack)()),t&&(yield(0,s.mainTradeIt)()),n?yield(0,o.mainTradeOffer)():r&&(yield(0,i.mainClassifieds)())}))}()},122:function(e,t,n){var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(o,i){function a(e){try{c(r.next(e))}catch(e){i(e)}}function s(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,s)}c((r=r.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.isTradeItUrl=function(e){return/^https:\/\/tradeit.gg\/tf2.+$/.test(e)},t.mainTradeIt=function(){return r(this,void 0,void 0,(function*(){(0,o.listenForDynamicallyAddedItems)("item-details","tradeit.gg")}))};const o=n(36),i=document.querySelector(".site-inventory");window.addEventListener("item_added",(e=>{const t=e.detail.item;if("tradeit.gg"===e.detail.initiator)if(i.contains(t)){const e=t.querySelector(".price").querySelector(".d-inline-block"),n=parseFloat(e.textContent.replace("$","")),r=11.5,o=`<div class="d-inline-block" style="display: flex; justify-content: space-between; width: 100%; text-align: right; color: gray">~$${Math.floor(100*(n-n*(r/100)))/100}</div>`;e.insertAdjacentHTML("afterend",o)}else t.classList.contains("unavailable")&&t.parentNode.parentNode.parentNode.remove()}))},849:function(e,t,n){var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(o,i){function a(e){try{c(r.next(e))}catch(e){i(e)}}function s(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,s)}c((r=r.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.isTradeOfferUrl=function(e){return/^https:\/\/steamcommunity\.com\/tradeoffer\/new\/\?partner=\d+&token=.+$/.test(e)},t.mainTradeOffer=function(){return r(this,void 0,void 0,(function*(){const e=new u;!function(){function e(e,t){let n=(0,o.getWindow)().CTradeOfferStateManager[e];(0,o.getWindow)().CTradeOfferStateManager[e]=function r(i,a,s){(0,o.getWindow)().CTradeOfferStateManager[e]=n,(0,o.getWindow)().CTradeOfferStateManager[e](i,a,s),n=(0,o.getWindow)().CTradeOfferStateManager[e],(0,o.getWindow)().CTradeOfferStateManager[e]=r;const c=new CustomEvent("item_interaction",{detail:{user:i.is_their_item?"UserThem":"UserYou",item:i,type:t}});window.dispatchEvent(c)}}function t(e,t){const n=document.querySelector(`#${e}`);null==n||n.addEventListener("click",(()=>{(0,o.getWindow)().SelectInventoryFromUser((0,o.getWindow)()[t],440,2,!1);const e=(0,o.getWindow)()[t]===(0,o.getWindow)().UserThem,n=new CustomEvent("inventory_selected",{detail:{user:e?"UserThem":"UserYou"}});window.dispatchEvent(n)}))}e("SetItemInTrade","added"),e("RemoveItemFromTrade","removed"),t("inventory_select_your_inventory","UserYou"),t("inventory_select_their_inventory","UserThem")}(),d("UserYou"),d("UserThem"),window.addEventListener("inventory_load_complete",(t=>r(this,void 0,void 0,(function*(){const n=t.detail.user,r="UserYou"===n,i="UserThem"===n;if((0,o.log)("Main.inventory_load_complete",`${n} inventory was loaded.`),r&&(a=!0,e.updateCurrencies(n)),i&&(s=!0),a&&s){const e=new CustomEvent("both_inventories_loaded");window.dispatchEvent(e)}})))),window.addEventListener("both_inventories_loaded",(()=>r(this,void 0,void 0,(function*(){const e=new URLSearchParams(location.search).get("ype"),t=e?JSON.parse(e):{};let{intent:n,asset_id:r,item_name:a,item_data:s,amount:l,currencies:d}=t;if(!e)return;if(!n||!s||!d){const e="Missing parameters: 'intent', 'item_data' or 'currencies'.";(0,o.alert)(e),(0,o.throwError)(e)}const u=[],f=[];if("sell"===n){if(!r||!l){const e="Missing parameters: 'asset_id' or 'amount'.";(0,o.alert)(e),(0,o.throwError)(e)}if(f){const e=(0,i.getRgItemByAssetId)("UserThem",r);if(e&&f.push(e),!a){const e="Missing parameters: 'item_name'.";(0,o.alert)(e),(0,o.throwError)(e)}let t=(0,i.getRgItemsByName)("UserThem",a);if(e&&(t=t.filter((e=>e.id!=r))),"craftable"in s){const e=s.craftable;t=t.filter((t=>{if("descriptions"in t){const n=Object.values(t.descriptions).find((e=>"( Not Usable in Crafting )"===e.value));if(e&&!n)return!0;if(!e&&n)return!0}return!1}))}if(t=t.slice(0,l-f.length),f.push(...t),0===f.length){const e="Item('s) has already been sold.";(0,o.alert)(e),(0,o.throwError)(e)}}if(u){let e=Math.round(d.metal/.05555555555555555);const t=f.length;for(;f.length>0;){let r=f.length;const i=c(n,d.keys*r,e*r/18);if(""===i.error_message){const e=l-t,n=f.length;e>0&&n<t?(0,o.alert)(`${t} out of ${l} items were found,\nand only ${n} out of ${t} are adjusted to your available currency.\nAdding ${n} items to the trade offer...`):e>0?(0,o.alert)(`${t} out of ${l} items were found,\nAdding ${n} items to the trade offer...`):n<t&&(0,o.alert)(`${n} out of ${t} are adjusted to your available currency.\nAdding ${n} items to the trade offer...`),u.push(...i.rg_items_to_give),f.push(...i.rg_items_to_receive);break}f.pop(),0===f.length&&((0,o.alert)(i.error_message),(0,o.throwError)(i.error_message))}}}else{if(!l||!d){const e="Missing parameters: 'amount' or 'currencies'.";(0,o.alert)(e),(0,o.throwError)(e)}if(u){if(!a){const e="Missing parameters: 'item_name'.";(0,o.alert)(e),(0,o.throwError)(e)}let e=(0,i.getRgItemsByName)("UserYou",a);if("craftable"in s){const t=s.craftable;e=e.filter((e=>{if("descriptions"in e){const n=Object.values(e.descriptions).find((e=>"( Not Usable in Crafting )"===e.value));if(t&&!n)return!0;if(!t&&n)return!0}return!1}))}if(e=e.slice(0,l-u.length),u.push(...e),0===u.length){const e="Item('s) were not found.";(0,o.alert)(e),(0,o.throwError)(e)}}if(f){let e=Math.round(d.metal/.05555555555555555);const t=u.length;for(;u.length>0;){let r=u.length;const i=c(n,d.keys*r,e*r/18);if(""===i.error_message){const e=l-t,n=u.length;e>0&&n<t?(0,o.alert)(`${t} out of ${l} items were found,\nand only ${n} out of ${t} are adjusted to their available currency.\nAdding ${n} items to the trade offer...`):e>0?(0,o.alert)(`${t} out of ${l} items were found,\nAdding ${n} items to the trade offer...`):n<t&&(0,o.alert)(`${n} out of ${t} are adjusted to their available currency.\nAdding ${n} items to the trade offer...`),u.push(...i.rg_items_to_receive),f.push(...i.rg_items_to_give);break}u.pop(),0===u.length&&((0,o.alert)(i.error_message),(0,o.throwError)(i.error_message))}}}const m=u.map((e=>e.id)),h=f.map((e=>e.id));(0,i.SetItemsInTrade)(m),(0,i.SetItemsInTrade)(h)})))),window.addEventListener("item_interaction",(t=>{const n=t.detail.user;t.detail.item,e.updateCurrencies(n)})),window.addEventListener("inventory_selected",(t=>{const n=t.detail.user;e.updateCurrencies(n)}))}))};const o=n(279),i=n(373);let a=!1,s=!1;function c(e,t,n){const r={rg_items_to_give:[],rg_items_to_receive:[],error_message:""},o=function(e,t){let n=Math.round(t/.05555555555555555),r=Math.floor(n/18);n-=18*r;let o=Math.floor(n/6);n-=6*o;let i=Math.floor(n/2);return n-=2*i,{key_amount:e,refined_amount:r,reclaimed_amount:o,scrap_amount:i}}(t,n);if("sell"===e){const[e,t,n]=l("UserYou",o);if(Object.values(t).find((e=>0!==e))||n){const[e,n,o]=l("UserThem",t);if(Object.values(n).find((e=>0!==e))||o)return r.error_message="Could not balance currencies.",r;for(let t of e)r.rg_items_to_receive.push(t)}for(let t of e)r.rg_items_to_give.push(t)}else{const[e,t]=l("UserThem",o);if(Object.values(t).find((e=>0!==e))){const[e,n]=l("UserYou",t);if(Object.values(n).find((e=>0!==e)))return r.error_message="Could not balance currencies.",r;for(let t of e)r.rg_items_to_give.push(t)}for(let t of e)r.rg_items_to_receive.push(t)}return r}function l(e,t){const n=(0,i.getRgItems)(e);let{key_amount:r,refined_amount:o,reclaimed_amount:a,scrap_amount:s}=t;const c=n.filter((e=>"Mann Co. Supply Crate Key"===e.name)),l=n.filter((e=>"Refined Metal"===e.name)),d=n.filter((e=>"Reclaimed Metal"===e.name)),u=n.filter((e=>"Scrap Metal"===e.name));if(c.length<r)return[[],[],"Insufficient keys."];if(l.length+d.length/3+u.length/9<o+a/3+s/9)return[[],[],"Insufficient metal."];let f=l.length-o,m=d.length-a,h=u.length-s,g={key_amount:0,refined_amount:0,reclaimed_amount:0,scrap_amount:0};for(h<0&&(h=-h,a+=Math.ceil(h/3),m-=Math.ceil(h/3),g.scrap_amount+=3-h%3,g.scrap_amount%=3,s-=h,h=0),m<0&&(m=-m,o+=Math.ceil(m/3),f-=Math.ceil(m/3),g.reclaimed_amount+=3-m%3,g.reclaimed_amount%=3,a-=m,m=0);f<0;){if(!(m>=3*-f))return[[],[],"Could not balance currencies."];o-=-f,a+=3*-f,m-=3*-f,f=0}if(0!=o&&0!=g.refined_amount){let e=Math.min(o,g.refined_amount);o-=e,g.refined_amount-=e}if(0!=a&&0!=g.reclaimed_amount){let e=Math.min(a,g.reclaimed_amount);a-=e,g.reclaimed_amount-=e}if(0!=s&&0!=g.scrap_amount){let e=Math.min(s,g.scrap_amount);s-=e,g.scrap_amount-=e}const p=Math.floor(Math.random()*(c.length-r+1)),y=Math.floor(Math.random()*(l.length-o+1)),v=Math.floor(Math.random()*(d.length-a+1)),w=Math.floor(Math.random()*(u.length-s+1)),_=c.slice(p,p+r),b=l.slice(y,y+o),I=d.slice(v,v+a),x=u.slice(w,w+s);let k=_;return k=k.concat(b),k=k.concat(I),k=k.concat(x),r<0||o<0||a<0||s<0||g.refined_amount<0||g.reclaimed_amount<0||g.scrap_amount<0||p<0||y<0||v<0||w<0||null==r||null==o||null==a||null==s||r>c.length||o>l.length||a>d.length||s>u.length||k.length<r||_.length!=r||b.length!=o||I.length!=a||x.length!=s?(console.log("Something went wrong balancing currencies:"),console.log([c.length,l.length,d.length,u.length,r,o,a,s,p,y,v,w,_,b,I,x,JSON.stringify(k,void 0,4)].join("\n")),[[],[],"Could not balance currencies."]):[k,g]}function d(e){const t="UserThem"===e;if("UserYou"!==e&&!t)return(0,o.error)("[YPE, Main.loadInventory]",`Unknown user '${e}'.`);t&&(0,o.getWindow)()[e].loadInventory(440,2);const n=(0,o.getWindow)()[e].OnLoadInventoryComplete;(0,o.getWindow)()[e].OnLoadInventoryComplete=function(r,i,a){(0,o.getWindow)()[e].OnLoadInventoryComplete=n,(0,o.getWindow)()[e].OnLoadInventoryComplete(r,i,a);const s=(0,o.getWindow)()[e].getInventory(440,2);t&&(s.Initialize(),s.MakeActive(),(0,o.getWindow)().g_ActiveInventory=s,(0,o.getWindow)().g_ActiveInventory.hide(),(0,o.getWindow)().SelectInventoryFromUser((0,o.getWindow)().UserYou,440,2,!1));const c=new CustomEvent("inventory_load_complete",{detail:{user:e,inventory:s}});window.dispatchEvent(c)}}class u{constructor(){var e,t;this.items=new f;const n=document.querySelector(".trade_right.selectableNone");null==n||n.insertAdjacentHTML("afterbegin",'<div id="currency-panel" class="your_items">\n    <div class="trade_box_bgheader active"></div>\n    <div class="trade_box_contents" style="background: #1D1D1D">\n        <div id="warning-text" class="tutorial_arrow_ctn" style="text-align: center; color: #d83636"></div>\n        <div class="tutorial_arrow_ctn" style="display: flex; flex-direction: row; flex-wrap: nowrap; justify-content: space-around; align-items: stretch; align-content: stretch;">\n            <div style="position: relative; text-align: center; color: white"><img src="https://community.cloudflare.steamstatic.com/economy/image/fWFc82js0fmoRAP-qOIPu5THSWqfSmTELLqcUywGkijVjZULUrsm1j-9xgEAaR4uURrwvz0N252yVaDVWrRTno9m4ccG2GNqxlQoZrC2aG9hcVGUWflbX_drrVu5UGki5sAij6tOtQ/96fx96f"><div id="key-count" style="position: absolute; bottom: 10px; right: 10px">0x</div></div>\n            <div style="position: relative; text-align: center; color: white"><img src="https://community.cloudflare.steamstatic.com/economy/image/fWFc82js0fmoRAP-qOIPu5THSWqfSmTELLqcUywGkijVjZULUrsm1j-9xgEbZQsUYhTkhzJWhsO1Mv6NGucF1Ygzt8ZQijJukFMiMrbhYDEwI1yRVKNfD6xorQ3qW3Jr6546DNPuou9IOVK4p4kWJaA/96fx96f"><div id="ref-count" style="position: absolute; bottom: 10px; right: 10px">0x</div></div>\n            <div style="position: relative; text-align: center; color: white"><img src="https://community.cloudflare.steamstatic.com/economy/image/fWFc82js0fmoRAP-qOIPu5THSWqfSmTELLqcUywGkijVjZULUrsm1j-9xgEbZQsUYhTkhzJWhsO0Mv6NGucF1YJlscMEgDdvxVYsMLPkMmFjI1OSUvMHDPBp9lu0CnVluZQxA9Gwp-hIOVK4sMMNWF4/96fx96f"><div id="rec-count" style="position: absolute; bottom: 10px; right: 10px">0x</div></div>\n            <div style="position: relative; text-align: center; color: white"><img src="https://community.cloudflare.steamstatic.com/economy/image/fWFc82js0fmoRAP-qOIPu5THSWqfSmTELLqcUywGkijVjZULUrsm1j-9xgEbZQsUYhTkhzJWhsPZAfOeD-VOn4phtsdQ32ZtxFYoN7PkYmVmIgeaUKNaX_Rjpwy8UHMz6pcxAIfnovUWJ1t9nYFqYw/96fx96f"><div id="scrap-count" style="position: absolute; bottom: 10px; right: 10px">0x</div></div>\n        </div>\n        <div style="display: flex; flex-direction: row; flex-wrap: nowrap; justify-content: space-around; align-items: stretch; align-content: stretch;" class="tutorial_arrow_ctn">\n            <input id="keys" placeholder="Keys" class="filter_search_box" type="number">\n            <input id="metal" placeholder="Metal" class="filter_search_box" type="number">\n            <a id="add-currency" class="pagecontrol_element pagebtn">Add</a>\n        </div>\n    </div>\n</div>'),null===(t=null===(e=this.get())||void 0===e?void 0:e.querySelector("#add-currency"))||void 0===t||t.addEventListener("click",(()=>r(this,void 0,void 0,(function*(){var e;const t=document.querySelector("#keys"),n=document.querySelector("#metal");if(!t||!n)return(0,o.throwError)("Cannot find 'keys' or 'metal' element.");const r=t.value?parseInt(t.value):0;let a=n.value?parseFloat(n.value):0;if(isNaN(r)||isNaN(a))return(0,o.alert)("Only numbers are allowed in 'keys' and 'metal' textboxes."),(0,o.throwError)("Only numbers are allowed in 'keys' and 'metal' textboxes.");if(r<0||a<0)return(0,o.alert)("Only non-negative numbers are allowed in 'keys' and 'metal' textboxes."),(0,o.throwError)("Only non-negative numbers are allowed in 'keys' and 'metal' textboxes.");const s=(0,o.getWindow)().g_ActiveUser===(0,o.getWindow)().UserThem?"UserThem":"UserYou",c=this.items.getCurrenciesInInventory(s);let l=Math.round(a/.05555555555555555),d=Math.floor(l/18);d=Math.min(c.ref.length,d),l-=18*d;let u=Math.floor(l/6);u=Math.min(c.rec.length,u),l-=6*u;let f=Math.floor(l/2);if(f=Math.min(c.scrap.length,f),l-=2*f,r>c.key.length||l>0){const e=0===r?0:r-c.key.length,t=Math.floor(l/18*100)/100;e&&t?this.showWarning(`You are missing ${e} keys ${t} metal.`):e?this.showWarning(`You are missing ${e} keys.`):this.showWarning(`You are missing ${t} metal.`)}else{this.hideWarning();const t=[...c.key.slice(0,r),...c.ref.slice(0,d),...c.rec.slice(0,u),...c.scrap.slice(0,f)].map((e=>e.id)),n=null===(e=this.get())||void 0===e?void 0:e.querySelector("#add-currency");null==n||n.classList.add("disabled"),yield(0,i.SetItemsInTrade)(t),null==n||n.classList.remove("disabled"),this.updateCurrencies(s)}}))))}get(){return document.querySelector("#currency-panel")}setKeys(e){this.get().querySelector("#keys").value=e}setMetal(e){this.get().querySelector("#metal").value=e}showWarning(e){document.querySelector("#warning-text").textContent=e}hideWarning(){document.querySelector("#warning-text").textContent=""}updateCurrencies(e){const t=this.items.getCurrenciesInInventory(e);this.updateCurrency("key-count",t.key.length),this.updateCurrency("ref-count",t.ref.length),this.updateCurrency("rec-count",t.rec.length),this.updateCurrency("scrap-count",t.scrap.length)}updateCurrency(e,t){["key-count","ref-count","rec-count","scrap-count"].includes(e)||(0,o.throwError)(`Item id '${e}' is not valid.`);const n=document.querySelector(`#${e}`);n?(n.parentNode.style.opacity=t>0?"100%":"40%",n.textContent=`${t}x`):(0,o.throwError)(`Element '${e}' was not found.`)}}class f{constructor(){this.class_ids={key:"101785959",ref:"2674",rec:"5564",scrap:"2675"}}getCurrenciesInInventory(e){return{key:this.getItemsByClassId(e,this.class_ids.key),ref:this.getItemsByClassId(e,this.class_ids.ref),rec:this.getItemsByClassId(e,this.class_ids.rec),scrap:this.getItemsByClassId(e,this.class_ids.scrap)}}getItemsByClassId(e,t){"UserYou"===e||"UserThem"===e||(0,o.throwError)(`Unknown user '${e}'.`);const n=(0,o.getWindow)()[e].getInventory(440,2).rgInventory,r=[];for(let e in n){const i=n[e],a=i.element;(0,o.getWindow)().BIsInTradeSlot(a)||i.classid===t&&r.push(i)}return r}}},36:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.listenForDynamicallyAddedItems=function(e,t){function n(r){if(1===r.nodeType&&e.split(" ").every((e=>r.classList.contains(e)))){const e=new CustomEvent("item_added",{detail:{item:r,initiator:t}});window.dispatchEvent(e)}if(1===r.nodeType&&r.children.length>0)for(let e of r.children)n(e)}new MutationObserver(((e,t)=>{for(let t of e)"childList"===t.type&&t.addedNodes.forEach((e=>{n(e)}))})).observe(document.body,{childList:!0,subtree:!0})}},564:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.getCompletePercentage=function(e){const t=a(e),n=i(e),s=function(e){let t=0;for(let n of e){const e=n.robo_part,i=n.amount,a=o[e];if(!e.includes("Killstreak Item")){if(!a){const t=`Unknown robo part: '${n[e]}'`;(0,r.alert)(t),(0,r.throwError)(t)}t+=a*i}}return t}(t),c=s/(n?24.5:24.1)*100;return Math.floor(100*c)/100},t.getKillstreakItemAmount=function(e){let t=0;for(let n of e){const e=n.robo_part,r=n.amount;e.includes("Killstreak Item")&&(t+=r)}return t},t.isSpecializedKillstreak=i,t.isProfessionalKillstreak=function(e){return"3"===e.getAttribute("data-ks_tier")},t.getNeededInput=a;const r=n(279),o={"Pristine Robot Brainstorm Bulb":2.5,"Pristine Robot Currency Digester":2.5,"Battle-Worn Robot Taunt Processor":1,"Battle-Worn Robot KB-808":1,"Battle-Worn Robot Money Furnace":1,"Reinforced Robot Emotion Detector":.1,"Reinforced Robot Humor Suppression Pump":.1,"Reinforced Robot Bomb Stabilizer":.1};function i(e){return"2"===e.getAttribute("data-ks_tier")}function a(e){let t=[],n=1;for(;;){const r=e.getAttribute(`data-input_${n}`);if(!r)break;let o=r.split("x"),i=o[0].trim(),a=parseInt(o[1].trim());t.push({robo_part:i,amount:a}),n++}return t}},373:function(e,t,n){var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(o,i){function a(e){try{c(r.next(e))}catch(e){i(e)}}function s(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,s)}c((r=r.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.SetItemsInTrade=function(e){return r(this,void 0,void 0,(function*(){return new Promise((t=>r(this,void 0,void 0,(function*(){const n=(0,o.getWindow)().CTradeOfferStateManager;for(let t of e){const e=document.querySelector(`#item440_2_${t}`);if(e){const r=e.rgItem;(0,o.getWindow)().BIsInTradeSlot(r)?(alert(`Item with id '${t}' is already in a trade slot.`),(0,o.error)("TradeOffer.SetItemsInTrade",`Item with id '${t}' is already in a trade slot.`)):yield new Promise((e=>{setTimeout((()=>{n.SetItemInTrade(r,0,1),e(!0)}),1)}))}else alert(`Item with id '${t}' not found.`),(0,o.error)("TradeOffer.SetItemsInTrade",`Item with id '${t}' not found.`)}t(e)}))))}))},t.SetItemInTrade=function(e){return r(this,void 0,void 0,(function*(){return new Promise(((t,n)=>r(this,void 0,void 0,(function*(){const r=document.querySelector(`#item440_2_${e}`);if(r){const i=r.rgItem;(0,o.getWindow)().BIsInTradeSlot(i)?n(`Item with id '${e}' is already in a trade slot.`):(yield new Promise((e=>{setTimeout((()=>{(0,o.getWindow)().CTradeOfferStateManager.SetItemInTrade(i,0,1),e(!0)}),1)})),t(!0))}else n(`Item with id '${e}' not found.`);t(!1)}))))}))},t.getRgItemsByName=function(e,t){"UserYou"===e||"UserThem"===e||(0,o.throwError)(`Unknown user '${e}'.`);const n=(0,o.getWindow)()[e].getInventory(440,2).rgInventory,r=[];for(let e in n){const i=n[e],a=i.market_name;(0,o.getWindow)().BIsInTradeSlot(i)||(a===t||a.startsWith("The ")&&a.substring(4)===t)&&r.push(i)}return r},t.getRgItemByAssetId=function(e,t){"UserYou"===e||"UserThem"===e||(0,o.throwError)(`Unknown user '${e}'.`);const n=(0,o.getWindow)()[e].getInventory(440,2).rgInventory;for(let e in n){const r=n[e];if(!(0,o.getWindow)().BIsInTradeSlot(r)&&e===t)return r}},t.removeItemFromTradeOffer=function(e){},t.refreshTradeStatus=function(){(0,o.getWindow)().RefreshTradeStatus((0,o.getWindow)().g_rgCurrentTradeStatus)},t.getRgItems=function(e){return Object.values((0,o.getWindow)()[e].getInventory(440,2).rgInventory)};const o=n(279)}},t={};!function n(r){var o=t[r];if(void 0!==o)return o.exports;var i=t[r]={exports:{}};return e[r].call(i.exports,i,i.exports,n),i.exports}(279)})();