// ==UserScript==
// @name            Your Personal Engineer
// @description     Makes your trading routine more comfortable.
// @author          https://steamcommunity.com/id/EurekaEffect/
// @version         1.0

// @updateURL       https://github.com/EurekaEffect/your-personal-engineer/raw/refs/heads/master/output/ype.bundle.user.js
// @downloadURL     https://github.com/EurekaEffect/your-personal-engineer/raw/refs/heads/master/output/ype.bundle.user.js

// @match           *://backpack.tf/stats/*
// @match           *://backpack.tf/classifieds*
// @match           *://steamcommunity.com/tradeoffer/new*

// @run-at          document-idle
// ==/UserScript==
(()=>{"use strict";var e={279:function(e,t,n){var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(o,i){function a(e){try{c(r.next(e))}catch(e){i(e)}}function s(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,s)}c((r=r.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.alert=function(e){window.alert(`Script: Your Personal Engineer\nMessage: ${e}`)},t.log=function(e,t){console.log(`[YPE, ${e}] ${t}`)},t.error=function(e,t){console.error(`[YPE, ${e}] ${t}`)},t.throwError=function(e){throw Error(e)},t.getWindow=function(){return unsafeWindow};const o=n(849);!function(){r(this,void 0,void 0,(function*(){(0,o.isTradeOfferUrl)(location.href)&&(yield(0,o.main)())}))}()},849:function(e,t,n){var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(o,i){function a(e){try{c(r.next(e))}catch(e){i(e)}}function s(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,s)}c((r=r.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.isTradeOfferUrl=function(e){return/^https:\/\/steamcommunity\.com\/tradeoffer\/new\/\?partner=\d+&token=.+$/.test(e)},t.main=function(){return r(this,void 0,void 0,(function*(){const e=new s;!function(){function e(e,t){let n=(0,o.getWindow)().CTradeOfferStateManager[e];(0,o.getWindow)().CTradeOfferStateManager[e]=function r(i,a,s){(0,o.getWindow)().CTradeOfferStateManager[e]=n,(0,o.getWindow)().CTradeOfferStateManager[e](i,a,s),n=(0,o.getWindow)().CTradeOfferStateManager[e],(0,o.getWindow)().CTradeOfferStateManager[e]=r;const c=new CustomEvent("item_interaction",{detail:{user:i.is_their_item?"UserThem":"UserYou",item:i,type:t}});window.dispatchEvent(c)}}function t(e,t){const n=document.querySelector(`#${e}`);null==n||n.addEventListener("click",(()=>{(0,o.getWindow)().SelectInventoryFromUser((0,o.getWindow)()[t],440,2,!1);const e=(0,o.getWindow)()[t]===(0,o.getWindow)().UserThem,n=new CustomEvent("inventory_selected",{detail:{user:e?"UserThem":"UserYou"}});window.dispatchEvent(n)}))}e("SetItemInTrade","added"),e("RemoveItemFromTrade","removed"),t("inventory_select_your_inventory","UserYou"),t("inventory_select_their_inventory","UserThem")}(),a("UserYou"),a("UserThem"),window.addEventListener("inventory_load_complete",(t=>{const n=t.detail.user,r="UserYou"===n,a="UserThem"===n,s=(t.detail.inventory.rgInventory,new URLSearchParams(location.search)),c=s.get("ype.asset_id"),d=s.get("ype.item_name");if((0,o.log)("Main.inventory_load_complete",`${n} inventory was loaded.`),r&&e.updateCurrencies(n),a&&c)try{(0,o.log)("Main.inventory_load_complete",`Adding an item with id '${c}' to the trade offer.`),(0,i.SetItemInTrade)(c)}catch(e){if((0,o.log)("Main.inventory_load_complete",`Item with id '${c}' not found.`),d){(0,o.log)("Main.inventory_load_complete",`Searching for '${d}' instead.`);const e=(0,i.SearchItemByName)(n,d);if(e)(0,o.log)("Main.inventory_load_complete",`Found an item with the exact name, it's id is '${e}', adding to the trade offer.`),(0,i.SetItemInTrade)(e);else{const e=`Cannot find an item with id '${c}' nor with item '${d}'.`;(0,o.alert)(e),(0,o.throwError)(e)}}else{const e=`Cannot find an item with id '${c}', 'ype.item_name' is not presents.`;(0,o.alert)(e),(0,o.throwError)(e)}}})),window.addEventListener("item_interaction",(t=>{const n=t.detail.user;t.detail.item,e.updateCurrencies(n)})),window.addEventListener("inventory_selected",(t=>{const n=t.detail.user;e.updateCurrencies(n)}))}))};const o=n(279),i=n(373);function a(e){const t="UserThem"===e;if("UserYou"!==e&&!t)return(0,o.error)("[YPE, Main.loadInventory]",`Unknown user '${e}'.`);t&&(0,o.getWindow)()[e].loadInventory(440,2);const n=(0,o.getWindow)()[e].OnLoadInventoryComplete;(0,o.getWindow)()[e].OnLoadInventoryComplete=function(r,i,a){(0,o.getWindow)()[e].OnLoadInventoryComplete=n,(0,o.getWindow)()[e].OnLoadInventoryComplete(r,i,a);const s=(0,o.getWindow)()[e].getInventory(440,2);t&&(s.Initialize(),s.MakeActive(),(0,o.getWindow)().g_ActiveInventory=s,(0,o.getWindow)().g_ActiveInventory.hide(),(0,o.getWindow)().SelectInventoryFromUser((0,o.getWindow)().UserYou,440,2,!1));const c=new CustomEvent("inventory_load_complete",{detail:{user:e,inventory:s}});window.dispatchEvent(c)}}class s{constructor(){var e,t;this.items=new c;const n=document.querySelector(".trade_right.selectableNone");null==n||n.insertAdjacentHTML("afterbegin",'<div id="currency-panel" class="your_items">\n    <div class="trade_box_bgheader active"></div>\n    <div class="trade_box_contents" style="background: #1D1D1D">\n        <div id="warning-text" class="tutorial_arrow_ctn" style="text-align: center; color: #d83636"></div>\n        <div class="tutorial_arrow_ctn" style="display: flex; flex-direction: row; flex-wrap: nowrap; justify-content: space-around; align-items: stretch; align-content: stretch;">\n            <div style="position: relative; text-align: center; color: white"><img src="https://community.cloudflare.steamstatic.com/economy/image/fWFc82js0fmoRAP-qOIPu5THSWqfSmTELLqcUywGkijVjZULUrsm1j-9xgEAaR4uURrwvz0N252yVaDVWrRTno9m4ccG2GNqxlQoZrC2aG9hcVGUWflbX_drrVu5UGki5sAij6tOtQ/96fx96f"><div id="key-count" style="position: absolute; bottom: 10px; right: 10px">0x</div></div>\n            <div style="position: relative; text-align: center; color: white"><img src="https://community.cloudflare.steamstatic.com/economy/image/fWFc82js0fmoRAP-qOIPu5THSWqfSmTELLqcUywGkijVjZULUrsm1j-9xgEbZQsUYhTkhzJWhsO1Mv6NGucF1Ygzt8ZQijJukFMiMrbhYDEwI1yRVKNfD6xorQ3qW3Jr6546DNPuou9IOVK4p4kWJaA/96fx96f"><div id="ref-count" style="position: absolute; bottom: 10px; right: 10px">0x</div></div>\n            <div style="position: relative; text-align: center; color: white"><img src="https://community.cloudflare.steamstatic.com/economy/image/fWFc82js0fmoRAP-qOIPu5THSWqfSmTELLqcUywGkijVjZULUrsm1j-9xgEbZQsUYhTkhzJWhsO0Mv6NGucF1YJlscMEgDdvxVYsMLPkMmFjI1OSUvMHDPBp9lu0CnVluZQxA9Gwp-hIOVK4sMMNWF4/96fx96f"><div id="rec-count" style="position: absolute; bottom: 10px; right: 10px">0x</div></div>\n            <div style="position: relative; text-align: center; color: white"><img src="https://community.cloudflare.steamstatic.com/economy/image/fWFc82js0fmoRAP-qOIPu5THSWqfSmTELLqcUywGkijVjZULUrsm1j-9xgEbZQsUYhTkhzJWhsPZAfOeD-VOn4phtsdQ32ZtxFYoN7PkYmVmIgeaUKNaX_Rjpwy8UHMz6pcxAIfnovUWJ1t9nYFqYw/96fx96f"><div id="scrap-count" style="position: absolute; bottom: 10px; right: 10px">0x</div></div>\n        </div>\n        <div style="display: flex; flex-direction: row; flex-wrap: nowrap; justify-content: space-around; align-items: stretch; align-content: stretch;" class="tutorial_arrow_ctn">\n            <input id="keys" placeholder="Keys" class="filter_search_box" type="number">\n            <input id="metal" placeholder="Metal" class="filter_search_box" type="number">\n            <a id="add-currency" class="pagecontrol_element pagebtn">Add</a>\n        </div>\n    </div>\n</div>'),null===(t=null===(e=this.get())||void 0===e?void 0:e.querySelector("#add-currency"))||void 0===t||t.addEventListener("click",(()=>{const e=document.querySelector("#keys"),t=document.querySelector("#metal");if(!e||!t)return(0,o.throwError)("Cannot find 'keys' or 'metal' element.");const n=e.value?parseInt(e.value):0;let r=t.value?parseFloat(t.value):0;if(isNaN(n)||isNaN(r))return(0,o.alert)("Only numbers are allowed in 'keys' and 'metal' textboxes."),(0,o.throwError)("Only numbers are allowed in 'keys' and 'metal' textboxes.");if(n<0||r<0)return(0,o.alert)("Only non-negative numbers are allowed in 'keys' and 'metal' textboxes."),(0,o.throwError)("Only non-negative numbers are allowed in 'keys' and 'metal' textboxes.");const a=(0,o.getWindow)().g_ActiveUser===(0,o.getWindow)().UserThem?"UserThem":"UserYou",s=this.items.getCurrenciesInInventory(a);let c=Math.round(r/.05555555555555555),d=Math.floor(c/18);d=Math.min(s.ref.length,d),c-=18*d;let l=Math.floor(c/6);l=Math.min(s.rec.length,l),c-=6*l;let u=Math.floor(c/2);if(u=Math.min(s.scrap.length,u),c-=2*u,n>s.key.length||c>0){const e=n-s.key.length,t=Math.floor(c/18*100)/100;e&&t?this.showWarning(`You are missing ${e} keys ${t} metal.`):e?this.showWarning(`You are missing ${e} keys.`):this.showWarning(`You are missing ${t} metal.`)}else this.hideWarning();const m=[...s.key.slice(0,n).map((e=>e.id)),...s.ref.slice(0,d).map((e=>e.id)),...s.rec.slice(0,l).map((e=>e.id)),...s.scrap.slice(0,u).map((e=>e.id))];(0,i.SetItemsInTrade)(m),this.updateCurrencies(a)}))}get(){return document.querySelector("#currency-panel")}showWarning(e){document.querySelector("#warning-text").textContent=e}hideWarning(){document.querySelector("#warning-text").textContent=""}updateCurrencies(e){const t=this.items.getCurrenciesInInventory(e);this.updateCurrency("key-count",t.key.length),this.updateCurrency("ref-count",t.ref.length),this.updateCurrency("rec-count",t.rec.length),this.updateCurrency("scrap-count",t.scrap.length)}updateCurrency(e,t){["key-count","ref-count","rec-count","scrap-count"].includes(e)||(0,o.throwError)(`Item id '${e}' is not valid.`);const n=document.querySelector(`#${e}`);n?(n.parentNode.style.opacity=t>0?"100%":"40%",n.textContent=`${t}x`):(0,o.throwError)(`Element '${e}' was not found.`)}}class c{constructor(){this.class_ids={key:"101785959",ref:"2674",rec:"5564",scrap:"2675"}}getCurrenciesInInventory(e){return{key:this.getItemsByClassId(e,this.class_ids.key),ref:this.getItemsByClassId(e,this.class_ids.ref),rec:this.getItemsByClassId(e,this.class_ids.rec),scrap:this.getItemsByClassId(e,this.class_ids.scrap)}}getItemsByClassId(e,t){"UserYou"===e||"UserThem"===e||(0,o.throwError)(`Unknown user '${e}'.`);const n=(0,o.getWindow)()[e].getInventory(440,2).rgInventory,r=[];for(let e in n){const i=n[e],a=i.element;(0,o.getWindow)().BIsInTradeSlot(a)||i.classid===t&&r.push(i)}return r}}},373:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.SetItemsInTrade=function(e){const t=(0,r.getWindow)().CTradeOfferStateManager,n=t.UpdateTradeStatus;t.UpdateTradeStatus=function(){};for(let n of e){const e=document.querySelector(`#item440_2_${n}`);if(e){const o=e.rgItem;(0,r.getWindow)().BIsInTradeSlot(o)?(0,r.throwError)(`Item with id '${n}' is already in a trade slot.`):setTimeout((()=>{t.SetItemInTrade(o,0,1)}),1)}else(0,r.throwError)(`Item with id '${n}' not found.`)}t.UpdateTradeStatus=n,t.UpdateTradeStatus()},t.SetItemInTrade=function(e){const t=document.querySelector(`#item440_2_${e}`);if(t){const n=t.rgItem;(0,r.getWindow)().BIsInTradeSlot(n)?(0,r.throwError)(`Item with id '${e}' is already in a trade slot.`):(0,r.getWindow)().CTradeOfferStateManager.SetItemInTrade(n,0,1)}else(0,r.throwError)(`Item with id '${e}' not found.`)},t.SearchItemByName=function(e,t){"UserYou"===e||"UserThem"===e||(0,r.throwError)(`Unknown user '${e}'.`);const n=(0,r.getWindow)()[e].getInventory(440,2).rgInventory;for(let e in n)if(n[e].market_name===t)return e},t.removeItemFromTradeOffer=function(e){},t.refreshTradeStatus=function(){(0,r.getWindow)().RefreshTradeStatus((0,r.getWindow)().g_rgCurrentTradeStatus)};const r=n(279)}},t={};!function n(r){var o=t[r];if(void 0!==o)return o.exports;var i=t[r]={exports:{}};return e[r].call(i.exports,i,i.exports,n),i.exports}(279)})();