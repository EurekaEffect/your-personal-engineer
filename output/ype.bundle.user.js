// ==UserScript==
// @name            Your Personal Engineer
// @description     Makes your trading routine more comfortable.
// @author          https://steamcommunity.com/id/EurekaEffect/
// @version         1.0

// @updateURL       https://github.com/EurekaEffect/your-personal-engineer/raw/refs/heads/master/output/ype.bundle.user.js
// @downloadURL     https://github.com/EurekaEffect/your-personal-engineer/raw/refs/heads/master/output/ype.bundle.user.js

// @match           *://backpack.tf/stats/*
// @match           *://backpack.tf/classifieds*
// @match           *://steamcommunity.com/tradeoffer/new*

// @run-at          document-idle
// ==/UserScript==
(()=>{"use strict";var e={971:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.trade_offer_currency_panel=void 0,t.trade_offer_currency_panel='<div class="your_items">\n    <div class="trade_box_bgheader active"></div>\n    <div class="trade_box_contents" style="background: #1D1D1D">\n        <div class="tutorial_arrow_ctn" style="display: flex; flex-direction: row; flex-wrap: nowrap; justify-content: space-around; align-items: stretch; align-content: stretch;">\n            <div style="position: relative; text-align: center; color: white"><img src="https://community.cloudflare.steamstatic.com/economy/image/fWFc82js0fmoRAP-qOIPu5THSWqfSmTELLqcUywGkijVjZULUrsm1j-9xgEAaR4uURrwvz0N252yVaDVWrRTno9m4ccG2GNqxlQoZrC2aG9hcVGUWflbX_drrVu5UGki5sAij6tOtQ/96fx96f"><div id="key-count" style="position: absolute; bottom: 10px; right: 10px">0x</div></div>\n            <div style="position: relative; text-align: center; color: white"><img src="https://community.cloudflare.steamstatic.com/economy/image/fWFc82js0fmoRAP-qOIPu5THSWqfSmTELLqcUywGkijVjZULUrsm1j-9xgEbZQsUYhTkhzJWhsO1Mv6NGucF1Ygzt8ZQijJukFMiMrbhYDEwI1yRVKNfD6xorQ3qW3Jr6546DNPuou9IOVK4p4kWJaA/96fx96f"><div id="ref-count" style="position: absolute; bottom: 10px; right: 10px">0x</div></div>\n            <div style="position: relative; text-align: center; color: white"><img src="https://community.cloudflare.steamstatic.com/economy/image/fWFc82js0fmoRAP-qOIPu5THSWqfSmTELLqcUywGkijVjZULUrsm1j-9xgEbZQsUYhTkhzJWhsO0Mv6NGucF1YJlscMEgDdvxVYsMLPkMmFjI1OSUvMHDPBp9lu0CnVluZQxA9Gwp-hIOVK4sMMNWF4/96fx96f"><div id="rec-count" style="position: absolute; bottom: 10px; right: 10px">0x</div></div>\n            <div style="position: relative; text-align: center; color: white"><img src="https://community.cloudflare.steamstatic.com/economy/image/fWFc82js0fmoRAP-qOIPu5THSWqfSmTELLqcUywGkijVjZULUrsm1j-9xgEbZQsUYhTkhzJWhsPZAfOeD-VOn4phtsdQ32ZtxFYoN7PkYmVmIgeaUKNaX_Rjpwy8UHMz6pcxAIfnovUWJ1t9nYFqYw/96fx96f"><div id="scrap-count" style="position: absolute; bottom: 10px; right: 10px">0x</div></div>\n        </div>\n        <div style="display: flex; flex-direction: row; flex-wrap: nowrap; justify-content: space-around; align-items: stretch; align-content: stretch;" class="tutorial_arrow_ctn">\n            <input id="keys" placeholder="Keys" class="filter_search_box">\n            <input id="metal" placeholder="Metal" class="filter_search_box">\n            <a id="add-currency" class="pagecontrol_element pagebtn">Add</a>\n        </div>\n    </div>\n</div>'},160:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.SCRAP_CLASS_ID=t.REF_CLASS_ID=t.REC_CLASS_ID=t.KEY_CLASS_ID=void 0,t.getCurrencies=function(e){return{key:o(e,t.KEY_CLASS_ID),ref:o(e,t.REC_CLASS_ID),rec:o(e,t.REF_CLASS_ID),scrap:o(e,t.SCRAP_CLASS_ID)}},t.getItemsByClassId=o;const r=n(279);function o(e,t){"UserYou"===e||"UserThem"===e||(0,r.throwError)(`Unknown user '${e}'.`);const n=(0,r.getWindow)()[e].getInventory(440,2).rgInventory,o=[];for(let e in n){const i=n[e],a=i.element,s=i.classid;(0,r.getWindow)().BIsInTradeSlot(a)||s===t&&o.push(i)}return o}t.KEY_CLASS_ID="101785959",t.REC_CLASS_ID="2674",t.REF_CLASS_ID="5564",t.SCRAP_CLASS_ID="2675"},279:function(e,t,n){var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(o,i){function a(e){try{c(r.next(e))}catch(e){i(e)}}function s(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,s)}c((r=r.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.alert=c,t.log=d,t.throwError=l,t.getWindow=u;const o=n(366),i=n(971),a=n(160);function s(e){const t="UserThem"===e;if("UserYou"!==e&&!t)return console.error(`[YPE, Main.loadInventory] Unknown user '${e}'.`);t&&u()[e].loadInventory(440,2);const n=u()[e].OnLoadInventoryComplete;u()[e].OnLoadInventoryComplete=function(r,o,i){u()[e].OnLoadInventoryComplete=n,u()[e].OnLoadInventoryComplete(r,o,i);const a=u()[e].getInventory(440,2);t&&(a.Initialize(),a.MakeActive(),u().g_ActiveInventory=a,u().g_ActiveInventory.hide(),u().SelectInventoryFromUser(u().UserYou,440,2,!1));const s=new CustomEvent("inventory_load_complete",{detail:{user:e,inventory:a}});window.dispatchEvent(s)}}function c(e){window.alert(`Script: Your Personal Engineer\nMessage: ${e}`)}function d(e,t){console.log(`[YPE, ${e}] ${t}`)}function l(e){throw Error(e)}function u(){return unsafeWindow}!function(){r(this,void 0,void 0,(function*(){if((0,o.isTradeOfferUrl)(location.href)){const e=document.querySelector(".trade_right.selectableNone");null==e||e.insertAdjacentHTML("afterbegin",i.trade_offer_currency_panel),function(){const e=document.querySelector("#inventory_select_your_inventory"),t=document.querySelector("#inventory_select_their_inventory");null==e||e.addEventListener("click",(()=>{u().SelectInventoryFromUser(u().UserYou,440,2,!1);const e=(0,a.getCurrencies)("UserYou");(0,o.updateCurrencies)(e)})),null==t||t.addEventListener("click",(()=>{u().SelectInventoryFromUser(u().UserThem,440,2,!1);const e=(0,a.getCurrencies)("UserThem");(0,o.updateCurrencies)(e)}))}(),function(){let e=u().CTradeOfferStateManager.SetItemInTrade;u().CTradeOfferStateManager.SetItemInTrade=function t(n,r,o){u().CTradeOfferStateManager.SetItemInTrade=e,u().CTradeOfferStateManager.SetItemInTrade(n,r,o),e=u().CTradeOfferStateManager.SetItemInTrade,u().CTradeOfferStateManager.SetItemInTrade=t;const i=new CustomEvent("item_interaction",{detail:{user:n.is_their_item?"UserThem":"UserYou",item:n,type:"added"}});window.dispatchEvent(i)};let t=u().CTradeOfferStateManager.RemoveItemFromTrade;u().CTradeOfferStateManager.RemoveItemFromTrade=function e(n){u().CTradeOfferStateManager.RemoveItemFromTrade=t,u().CTradeOfferStateManager.RemoveItemFromTrade(n),t=u().CTradeOfferStateManager.RemoveItemFromTrade,u().CTradeOfferStateManager.RemoveItemFromTrade=e;const r=new CustomEvent("item_interaction",{detail:{user:n.is_their_item?"UserThem":"UserYou",item:n,type:"removed"}});window.dispatchEvent(r)}}(),s("UserYou"),s("UserThem")}}))}(),window.addEventListener("inventory_load_complete",(e=>{const t=e.detail.user,n="UserYou"===t,r="UserThem"===t,i=(e.detail.inventory.rgInventory,new URLSearchParams(location.search)),s=i.get("ype.asset_id"),u=i.get("ype.item_name");if(d("Main.inventory_load_complete",`${t} inventory was loaded.`),n){const e=(0,a.getCurrencies)(t);(0,o.updateCurrencies)(e)}if(r&&s)try{d("Main.inventory_load_complete",`Adding an item with id '${s}' to the trade offer.`),(0,o.SetItemInTrade)(s)}catch(e){if(d("Main.inventory_load_complete",`Item with id '${s}' not found.`),u){d("Main.inventory_load_complete",`Searching for '${u}' instead.`);const e=(0,o.SearchItemByName)(t,u);if(e)d("Main.inventory_load_complete",`Found an item with the exact name, it's id is '${e}', adding to the trade offer.`),(0,o.SetItemInTrade)(e);else{const e=`Cannot find an item with id '${s}' nor with item '${u}'.`;c(e),l(e)}}else{const e=`Cannot find an item with id '${s}', 'ype.item_name' is not presents.`;c(e),l(e)}}})),window.addEventListener("item_interaction",(e=>{const t=e.detail.user,n=(e.detail.item,(0,a.getCurrencies)(t));(0,o.updateCurrencies)(n)}))},366:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.SetItemsInTrade=function(e){const t=(0,r.getWindow)().CTradeOfferStateManager,n=t.UpdateTradeStatus;t.UpdateTradeStatus=function(){};for(let n of e){const e=document.querySelector(`#item440_2_${n}`);if(e){const o=e.rgItem;(0,r.getWindow)().BIsInTradeSlot(o)?(0,r.throwError)(`Item with id '${n}' is already in a trade slot.`):t.SetItemInTrade(o,0,1)}else(0,r.throwError)(`Item with id '${n}' not found.`)}t.UpdateTradeStatus=n,t.UpdateTradeStatus()},t.SetItemInTrade=function(e){const t=document.querySelector(`#item440_2_${e}`);if(t){const n=t.rgItem;(0,r.getWindow)().BIsInTradeSlot(n)?(0,r.throwError)(`Item with id '${e}' is already in a trade slot.`):(0,r.getWindow)().CTradeOfferStateManager.SetItemInTrade(n,0,1)}else(0,r.throwError)(`Item with id '${e}' not found.`)},t.SearchItemByName=function(e,t){"UserYou"===e||"UserThem"===e||(0,r.throwError)(`Unknown user '${e}'.`);const n=(0,r.getWindow)()[e].getInventory(440,2).rgInventory;for(let e in n)if(n[e].market_name===t)return e},t.removeItemFromTradeOffer=function(e){},t.refreshTradeStatus=function(){(0,r.getWindow)().RefreshTradeStatus((0,r.getWindow)().g_rgCurrentTradeStatus)},t.isTradeOfferUrl=function(e){return/^https:\/\/steamcommunity\.com\/tradeoffer\/new\/\?partner=\d+&token=.+$/.test(e)},t.updateCurrencies=function(e){o("key-count",e.key.length),o("ref-count",e.ref.length),o("rec-count",e.rec.length),o("scrap-count",e.scrap.length)};const r=n(279);function o(e,t){["key-count","ref-count","rec-count","scrap-count"].includes(e)||(0,r.throwError)(`Item id '${e}' is not valid.`);const n=document.querySelector(`#${e}`);n?n.textContent=`${t}x`:(0,r.throwError)(`Element '${e}' was not found.`)}}},t={};!function n(r){var o=t[r];if(void 0!==o)return o.exports;var i=t[r]={exports:{}};return e[r].call(i.exports,i,i.exports,n),i.exports}(279)})();